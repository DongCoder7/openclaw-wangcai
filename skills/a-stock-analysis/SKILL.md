# A股个股深度分析 Skill v4.0 - 完整SOP

---

# ⚠️ 运行环境要求

## 使用venv虚拟环境运行

本Skill建议在venv中运行：

```bash
# 1. 激活虚拟环境
source /root/.openclaw/workspace/venv_activate.sh

# 2. 运行Python脚本
python3 your_script.py
```

## 在Python代码中指定解释器

```python
#!/root/.openclaw/workspace/venv/bin/python3
import sys
sys.path.insert(0, '/root/.openclaw/workspace/skills/a-stock-analysis/scripts')

# 你的代码...
```

## 检查Python版本

```bash
# 确保使用venv中的Python
which python3
# 应该输出: /root/.openclaw/workspace/venv/bin/python3
```

---

# ⚠️ 前置检查清单（必须执行！）

分析开始前必须完成以下检查，否则报告无效：

## 1. 真实股价获取（严禁瞎编！）

```python
# ✅ 正确：获取真实股价
import requests
url = 'https://qt.gtimg.cn/q=sz300548'
resp = requests.get(url)
parts = resp.text.split('~')
current_price = float(parts[3])  # 当前价格
market_cap = float(parts[44])    # 总市值

# 或 Tushare
import tushare as ts
df = ts.pro.daily(ts_code='300548.SZ', limit=1)
current_price = df['close'].values[0]
```

**检查点**:
- [ ] 是否获取了真实股价？（不是瞎编35元）
- [ ] 是否获取了总股本？（用于计算目标价）
- [ ] 是否标注了数据来源和获取时间？

## 2. 多源新闻搜索（必须使用！）

```python
from multi_source_news_v2 import search_stock_comprehensive

# ✅ 正确：全面搜索（自动执行6类关键词）
results = search_stock_comprehensive(
    stock_code="300548.SZ",
    stock_name="长芯博创",
    industry="光模块"
)
# 返回：基础 + 资本运作 + 风险 + 业务驱动 + 业绩 + 资本市场
```

**6类关键词必须全部搜索**：

| 类别 | 关键词 | 重要性 | 用途 |
|:-----|:-------|:------:|:-----|
| **基础** | 行业关键词 | ⭐⭐⭐⭐⭐ | 业务基本面 |
| **资本运作** | **并购、收购、定增、重组、借壳** | ⭐⭐⭐⭐⭐ | 重大事件（如鸿辉光联） |
| **风险** | **减持、增持、违规、处罚、监管、问询函、关注函、警示函** | ⭐⭐⭐⭐⭐ | 风险排查 |
| **业务驱动** | 订单、合同、中标、产能扩张、技术突破、专利、产品认证 | ⭐⭐⭐⭐⭐ | 业绩驱动 |
| **业绩** | 业绩预增、业绩快报、业绩下修、业绩变脸、扭亏、亏损 | ⭐⭐⭐⭐⭐ | 业绩验证 |
| **资本市场** | 研报、评级、目标价、机构调研、龙虎榜、大宗交易 | ⭐⭐⭐⭐ | 市场情绪 |

**检查点**:
- [ ] 是否调用 `search_stock_comprehensive()`？
- [ ] 是否搜索了6类关键词？
- [ ] Exa搜索是否使用"标的+关键词"格式？（如"长芯博创 并购"）
- [ ] 是否标注了数据来源和时效性？

## 3. 目标价计算（必须用真实数据！）

```python
# ✅ 正确：基于真实股价计算
current_price = 156.82  # 真实股价
total_shares = market_cap / current_price  # 总股本
target_price = target_market_cap / total_shares  # 目标价
upside = (target_price - current_price) / current_price * 100  # 涨跌幅
```

**检查点**:
- [ ] 目标价是否基于真实股价计算？
- [ ] 是否使用真实总股本？
- [ ] 涨跌幅计算是否正确？

## 4. 10环节检查清单

- [ ] 0️⃣ 投资摘要（含真实股价）
- [ ] 1️⃣ 公司基本画像
- [ ] 2️⃣ 业务结构分析
- [ ] 3️⃣ 产业链定位与竞争格局
- [ ] 4️⃣ 订单与产能分析
- [ ] 5️⃣ 财务深度分析
- [ ] 6️⃣ 行业景气度验证
- [ ] 7️⃣ 客户与供应商分析
- [ ] 8️⃣ 业绩预测与估值（基于真实股价）
- [ ] 9️⃣ 风险提示
- [ ] 🔟 投资建议

---

## 一、分析流程总览（10环节标准流程）

```
┌─────────────────────────────────────────────────────────────────┐
│  0. 投资摘要（前置）- 关键数据一目了然                           │
├─────────────────────────────────────────────────────────────────┤
│  1. 公司基本画像 - 业务定位+估值+概念板块                        │
├─────────────────────────────────────────────────────────────────┤
│  2. 业务结构分析 - 收入拆分+产品细分+核心竞争力                  │
├─────────────────────────────────────────────────────────────────┤
│  3. 产业链定位与竞争格局 - 产业链图+同行对比+竞争优势           │
├─────────────────────────────────────────────────────────────────┤
│  4. 订单与产能分析 - 产能布局+订单情况+扩产计划                 │
├─────────────────────────────────────────────────────────────────┤
│  5. 财务深度分析 - 利润表+盈利能力+杜邦分析+扣非验证            │
├─────────────────────────────────────────────────────────────────┤
│  6. 行业景气度验证 - 下游需求+国产替代趋势+政策支撑             │
├─────────────────────────────────────────────────────────────────┤
│  7. 客户与供应商分析 - 客户结构+集中度+供应商议价能力           │
├─────────────────────────────────────────────────────────────────┤
│  8. 业绩预测与估值 - 历史业绩+三情景估值+券商研报汇总           │
├─────────────────────────────────────────────────────────────────┤
│  9. 风险提示（分级）- 高/中/低风险+应对措施                     │
├─────────────────────────────────────────────────────────────────┤
│  10. 投资建议 - 综合评级+买入区间+目标价+跟踪指标               │
├─────────────────────────────────────────────────────────────────┤
│  附：数据源汇总 - 标注所有数据来源和时效性                       │
└─────────────────────────────────────────────────────────────────┘
```

---

## 二、详细SOP（标准操作程序）

### 环节0: 投资摘要（必须前置！）

**目的**: 让读者30秒内掌握核心信息

**必含表格**:
```markdown
| 项目 | 数据 | 来源 | 说明 |
|------|------|------|------|
| 当前股价 | XX元 | Tushare | 202X-XX-XX |
| 总市值 | XX亿元 | Tushare | 计算得出 |
| 202X年前三季度营收 | XX亿元 | Tushare | 同比+XX% |
| 202X年前三季度净利润 | XX亿元 | Tushare | 同比+XX% |
| 202X年预测净利润 | XX亿元 | 券商平均 | 同比+XX% |
| 202X年预测PE | XX倍 | 计算 | 基于XX亿市值 |
```

**一句话总结**: 
> "全球半导体XX龙头，技术领先（XXnm认证）+国产替代+业绩高速增长，但估值偏高。"

---

### 环节1: 公司基本画像

#### 1.1 基本信息
- 股票代码、公司名称、所属行业
- 实际控制人、企业性质、上市日期
- **主营业务一句话描述**

#### 1.2 市值与估值（Tushare实时）
```python
df = pro.daily_basic(ts_code='300666.SZ', trade_date='20260226')
pe_ttm = df['pe_ttm'].values[0]  # PE_TTM
pb = df['pb'].values[0]  # PB
total_mv = df['total_mv'].values[0] / 10000  # 总市值（万元→亿元）
```

**输出表格**:
| 指标 | 数值 | 评价 |
|------|------|------|
| PE_TTM | XX倍 | 偏高/合理/低估 |
| PB | XX倍 | - |
| 总市值 | XX亿元 | - |
| 股息率 | XX% | - |

#### 1.3 核心概念板块
用⭐标注重要性：
- ⭐⭐⭐⭐⭐ 核心业务概念
- ⭐⭐⭐⭐ 重要驱动概念
- ⭐⭐⭐ 辅助概念

---

### 环节2: 业务结构分析（重点优化！）

#### 2.1 收入结构（按业务线拆分）
```markdown
| 业务板块 | 202X年上半年 | 占比 | 增速 | 毛利率 |
|----------|-------------|------|------|--------|
| XX业务 | XX亿 | XX% | +XX% | XX% |
| XX业务 | XX亿 | XX% | +XX% | XX% |
```

#### 2.2 产品结构（重点！细分到具体产品）
```markdown
| 产品类型 | 占比 | 应用领域 | 技术壁垒 | 竞争格局 |
|----------|------|----------|----------|----------|
| XX产品 | XX% | 半导体 | 高 | 全球少数掌握 |
| XX产品 | XX% | 面板 | 中 | 竞争激烈 |
```

#### 2.3 客户集中度
- 核心客户列表（前3-5大客户）
- 客户集中度风险：CR5占比
- **客户质量评估**（是否为行业龙头）

---

### 环节3: 产业链定位与竞争格局（重点优化！）

#### 3.1 产业链定位图
**必须画产业链树状图**：
```
上游: XX原材料
  ↓
中游: 【公司】核心产品制造
  ↓
下游: XX行业应用
```

#### 3.2 竞争格局分析（关键！正确选择对比公司）

**同行业选择原则**（重要！）：
1. **同业务优先**: 直接竞争对手（产品相同/相似）
2. **同产业链**: 上下游关联公司
3. **同逻辑**: 同赛道不同细分（如都是半导体材料国产替代）
4. **标注差异**: 必须说明可比性和差异点

**案例分析 - 江丰电子**:
- ✅ **正确**: 对比阿石创（PVD镀膜材料）、隆华科技（ITO靶材）
- ❌ **错误**: 对比安集科技（抛光液，业务完全不同）

**输出表格**:
```markdown
| 公司 | 代码 | PE_TTM | PB | 总市值 | 主营业务 | 可比性说明 |
|------|------|--------|-----|--------|----------|------------|
| 目标公司 | XXX | XX | XX | XX亿 | XX业务 | - |
| 可比公司A | XXX | XX | XX | XX亿 | XX业务 | 同业务，规模差距X倍 |
| 可比公司B | XXX | XX | XX | XX亿 | XX业务 | 产业链上下游 |
```

#### 3.3 核心竞争力
用⭐标注护城河强度：
- 技术壁垒、客户认证、国产替代、业绩增长、产能扩张

---

### 环节4: 订单与产能分析

#### 4.1 产能布局
| 基地 | 位置 | 状态 | 产能贡献 |
|------|------|------|----------|
| XX基地 | XX | 🟢满产 | 主产能 |
| XX基地 | XX | 🟢投产 | 扩产中 |

#### 4.2 在手订单
- 订单金额（如有披露）
- 订单增速趋势
- 订单完成率

---

### 环节5: 财务深度分析（重点优化！）

#### 5.1 利润表分析（真实数据）
```markdown
| 年份 | 营收(亿) | 营收增速 | 净利润(亿) | 净利润增速 | 净利率 | ROE |
|------|----------|----------|------------|------------|--------|-----|
| 2022A | XX | - | XX | - | XX% | XX% |
| 2023A | XX | +XX% | XX | +XX% | XX% | XX% |
| 2024A | XX | +XX% | XX | +XX% | XX% | XX% |
| 2025Q3 | XX | - | XX | +XX% | XX% | XX% |
```

#### 5.2 盈利能力分析
- 毛利率趋势（分业务线）
- 净利率趋势
- ROE趋势

#### 5.3 杜邦分析
```
ROE = 净利率 × 资产周转率 × 权益乘数
    = XX% × XX × XX
    = XX%
```

#### 5.4 成长性验证（关键！新增）
**必须分析扣非净利润**:
```markdown
| 指标 | 2025Q1 | 同比 | 说明 |
|------|--------|------|------|
| 归母净利润 | 1.57亿 | +163.58% | 表面增速极高 |
| 扣非净利润 | 0.91亿 | +30.36% | 真实增速 |
| 投资收益 | 0.66亿 | - | 占净利润42% |
```

**判断标准**:
- ✅ 真成长: 扣非增速 ≈ 营收增速
- ⚠️ 需警惕: 扣非增速 << 归母增速（投资收益占比高）

---

### 环节6: 行业景气度验证

#### 6.1 下游需求景气度
| 下游行业 | 景气度 | 驱动因素 | 对公司影响 |
|----------|--------|----------|------------|
| XX行业 | 🟢极高 | AI/国产替代 | 核心受益 |
| XX行业 | 🟢高 | 扩产 | 需求增长 |

#### 6.2 国产替代趋势
| 技术节点 | 国产化率 | 主要供应商 | 公司进展 |
|----------|----------|------------|----------|
| 90nm以上 | 80%+ | 多家 | ✅批量供应 |
| 28-90nm | 60%+ | 少数 | ✅批量供应 |
| 7nm | 30%+ | 江丰+海外 | ✅批量应用 |
| 5nm | 10%+ | 海外为主 | ✅验证中 |

---

### 环节7: 客户与供应商分析

#### 7.1 客户结构
| 客户类型 | 占比 | 代表客户 | 特点 |
|----------|------|----------|------|
| 类型A | XX% | XX公司 | 高增长 |
| 类型B | XX% | XX公司 | 稳定 |

#### 7.2 供应商结构
| 供应品类 | 主要供应商 | 议价能力 | 风险等级 |
|----------|------------|----------|----------|
| XX材料 | XX公司 | 高 | 🟡中 |

---

### 环节8: 业绩预测与估值（重点优化！）

#### 8.1 历史业绩与预测
```markdown
| 年份 | 营收(亿) | 营收增速 | 净利润(亿) | 净利润增速 | 净利率 | 数据来源 |
|------|----------|----------|------------|------------|--------|----------|
| 2023A | XX | +XX% | XX | +XX% | XX% | **年报** |
| 2024A | XX | +XX% | XX | +XX% | XX% | **年报** |
| 2025E | XX | +XX% | XX | +XX% | XX% | **预测** |
| 2026E | XX | +XX% | XX | +XX% | XX% | **预测** |
```

**预测逻辑说明**: 基于XX产能释放+XX需求增长

#### 8.2 三情景估值（关键！）
```markdown
| 情景 | 净利润 | 给予PE | 目标价 | 当前价 | 空间 | 假设 |
|------|--------|--------|--------|--------|------|------|
| 保守 | XX亿 | XXx | XX元 | XX元 | XX% | 业绩miss |
| 中性 | XX亿 | XXx | XX元 | XX元 | XX% | 符合预期 |
| 乐观 | XX亿 | XXx | XX元 | XX元 | XX% | 超预期 |
```

#### 8.3 券商研报观点汇总（Tushare Pro）
```python
# 获取最新研报
df = pro.report_rc(ts_code='300666.SZ')
df_recent = df[df['report_date'] >= '20250101']
```

**输出表格**:
| 券商 | 评级 | 目标价 | 核心观点 | 日期 |
|------|------|--------|----------|------|
| XX证券 | 买入 | XX元 | XX | 202X-XX |

**统计**: 共XX条202X-202X年研报，平均目标价XX元

#### 8.4 估值敏感性分析（新增！）
```markdown
假设2026年净利润:
| 增速 | 净利润 | 2026年PE | PEG | 估值判断 |
|------|--------|----------|-----|----------|
| +15% | XX亿 | XX倍 | XX | 🔴 高估 |
| +25% | XX亿 | XX倍 | XX | 🟡 偏高 |
| +40% | XX亿 | XX倍 | XX | 🟢 合理 |
```

---

### 环节9: 风险提示（分级）

#### 9.1 🔴 高风险
| 风险类型 | 具体表现 | 影响 | 应对 |
|----------|----------|------|------|
| 估值过高 | PE XX倍 | 回归压力大 | 等待回调 |

#### 9.2 🟡 中风险
| 风险类型 | 具体表现 | 影响 | 应对 |
|----------|----------|------|------|
| 客户集中 | CR5占比XX% | 议价压力 | 拓展新客户 |

#### 9.3 🟢 低风险
| 风险类型 | 具体表现 | 影响 | 应对 |
|----------|----------|------|------|
| 行业周期 | 波动 | 短期影响 | 长期持有 |

---

### 环节10: 投资建议（重点优化！）

#### 10.1 投资逻辑评分
| 维度 | 评分 | 说明 |
|------|------|------|
| 行业景气度 | ⭐⭐⭐⭐⭐ | XX |
| 业绩成长性 | ⭐⭐⭐⭐⭐ | XX |
| 竞争优势 | ⭐⭐⭐⭐⭐ | XX |
| 估值合理性 | ⭐⭐ | XX |

#### 10.2 投资建议（关键！具体可操作）
| 建议项 | 内容 |
|--------|------|
| **综合评级** | 🟢买入/🟡持有/🔴卖出 |
| **核心逻辑** | 一句话总结 |
| **当前状态** | 估值/业绩/市场情绪 |
| **买入区间** | **¥XX-XX**（回调X%） |
| **止损位** | ¥XX（-X%） |
| **目标价** | XX元（+X%） |
| **建议仓位** | X-X% |
| **核心催化剂** | XX事件/数据 |

#### 10.3 关键跟踪指标
| 指标 | 频率 | 数据源 | 阈值 |
|------|------|--------|------|
| 季度净利润增速 | 季度 | Tushare | <X%警惕 |
| 毛利率 | 季度 | 财报 | <X%警惕 |
| XX占比 | 年报 | 公司披露 | 持续提升 |

---

## 三、数据源规范（重要！）

### 3.1 必须标注的数据源

**⚠️ 严格规定：所有实时数据必须从API获取，禁止从本地数据库获取！**

| 数据类型 | 首选来源 | 禁止来源 | 单位转换 |
|----------|----------|----------|----------|
| **估值数据** | Tushare daily_basic | ❌ 本地数据库 | 市值:万元→亿元(÷10000) |
| **财务数据** | Tushare income/fina_indicator | ❌ 本地数据库 | 营收/净利润:元→亿元(÷1e8) |
| **研报数据** | Tushare report_rc | ❌ 本地数据库 | - |
| **行情数据** | Tushare daily / 长桥API | ❌ 本地数据库 | - |
| **公司信息** | Tushare stock_basic | ❌ 本地数据库 | - |

**🚫 绝对禁止**:
- 从`sqlite3 data/historical/historical.db`获取实时股价、估值
- 使用本地缓存的财务数据（可能过时）
- 混用本地数据和API数据

**✅ 必须执行**:
- 每次分析前，重新调用Tushare Pro接口
- 标注数据来源和获取时间
- 多源交叉验证（Tushare + 长桥API）

**必须在报告开头和结尾标注**:
```markdown
> **数据来源**: Tushare Pro + 202X-202X年最新研报  
> **报告时间**: 202X-XX-XX  
> **数据时效**: 财报截至202X年Q3，估值截至202X-XX-XX
```

### 3.3 行业新闻与调研分析获取（重要！确保搜索完整性）

**⚠️ 严格规定：个股分析必须使用所有可用新闻搜索方式，综合整理！**

**优先级只是搜索顺序，不是只用P1！所有方式都必须使用并综合。**

#### 新闻搜索方式汇总

| 优先级 | 搜索方式 | 数据源 | 获取内容 | 必须使用 |
|:---:|:---|:---|:---|:---:|
| **P1** | Exa全网搜索 | AI语义搜索 | 行业动态、政策变化、公司新闻 | ✅ |
| **P2** | 新浪财经API | 新浪财经 | 公司公告、板块新闻 | ✅ |
| **P3** | 知识星球 | 调研纪要 | 产业链调研、专家观点、订单情况 | ✅ |
| **P4** | 券商研报 | Tushare report_rc | 业绩预测、目标价、投资评级 | ✅ |
| **P5** | 华尔街见闻 | 财经媒体 | 深度分析、行业数据 | ✅（如配置）|
| **P6** | 第一财经 | 财经媒体 | 政策解读、独家数据 | ✅（如配置）|

#### 新闻搜索执行流程

```python
# Step 1: Exa全网搜索（多个关键词）
mcporter call 'exa.web_search_exa({"query": "公司名称 最新动态 订单", "numResults": 10})'
mcporter call 'exa.web_search_exa({"query": "行业关键词 涨价 产能", "numResults": 10})'

# Step 2: 新浪财经API
curl "https://feed.mix.sina.com.cn/api/roll/get?pageid=153&lid=2516&num=10&keywords=公司名称"

# Step 3: 知识星球调研
python3 tools/zsxq_fetcher.py search --keyword "公司名称/行业" --count 10

# Step 4: 券商研报（Tushare）
pro.report_rc(ts_code='300666.SZ')

# Step 5: 其他新闻源（如配置了华尔街见闻、第一财经API）
# 调用对应API
```

#### 新闻综合整理要求

1. **必须列出所有搜索来源**（P1+P2+P3+P4+...）
2. **必须标注每则新闻的来源和时间**
3. **必须交叉验证**（多个来源报道同一事件）
4. **必须区分事实与观点**
5. **必须验证与业绩数据的匹配度**

#### 新闻输出格式示例

```markdown
## 多源新闻综合整理

### 搜索方式汇总
| 方式 | 来源 | 关键发现 |
|:---:|:---|:---|
| P1 Exa | 外部AI搜索 | 公司5nm产品突破 |
| P2 新浪 | 新浪财经 | 订单增长80% |
| P3 星球 | 调研纪要 | 产能利用率95% |
| P4 研报 | Tushare | 中信目标价150元 |

### 核心新闻验证
**【技术突破】** (Exa搜索 电子工程专辑 2026-01-07 / 知识星球验证)
• 公司5nm产品已进入台积电产线
• 验证：多个来源一致报道，与业绩数据匹配

**【订单情况】** (知识星球 2026-01-10)
• 订单排期至2027Q1
• 验证：与财报收入增长匹配

**【券商观点】** (Tushare 中信/中金研报 2026-01)
• 中信：买入，目标价150元
• 中金：跑赢行业，目标价145元
```

#### 数据缺失说明

如果某些数据无法获取，必须明确标注:
```markdown
⚠️ **缺失数据说明**:
| 缺失项 | 原因 | 建议获取方式 |
|--------|------|--------------|
| 最新调研纪要 | 知识星球权限受限 | 券商APP/公司IR |
| 机构持仓数据 | 需付费 | Wind/东方财富 |
```

---

## 四、并购/收购分析SOP（新增！）

当分析并购事件时，增加以下模块：

### 并购分析框架

#### 1. 交易概况
| 项目 | 内容 |
|------|------|
| 收购标的 | XX公司（代码） |
| 收购比例 | XX% |
| 交易金额 | XX亿元 |
| 支付方式 | 现金/股权 |

#### 2. 协同效应五维分析（关键！）

**2.1 客户协同**
- 客户重叠度分析（具体列出重叠客户）
- 交叉销售潜力
- 客户粘性提升

**2.2 供应链协同**
- 上游整合可能性
- 下游渠道共享
- 物流/仓储整合

**2.3 技术协同**
- 技术交叉点
- 研发协同
- 专利共享

**2.4 财务协同**
- 并表后收入/利润测算
- 毛利率影响
- ROE影响

**2.5 战略协同**
- 产业链一体化
- 平台化升级
- 估值重塑

#### 3. 时间维度分析
| 维度 | 影响 | 观察指标 |
|------|------|----------|
| 短期(6-12月) | 财务拖累/整合风险 | 并表数据 |
| 中期(1-2年) | 协同显现 | 交叉销售数据 |
| 长期(3-5年) | 平台成型 | 市场份额 |

#### 4. 风险提示
- 整合风险（文化/管理）
- 财务风险（现金支出/ROE下降）
- 业绩承诺风险

---

## 五、质量检查清单（发布前必查）

### 5.1 数据检查
- [ ] 所有数值标注数据来源
- [ ] 单位转换正确（市值:万元→亿元）
- [ ] 财务数据:元→亿元
- [ ] 同行对比公司选择正确
- [ ] 研报数据筛选202X-202X年最新
- [ ] **新闻搜索完整性（P1+P2+P3+P4+...）**
- [ ] **多源新闻交叉验证**

### 5.2 内容检查
- [ ] 投资摘要前置
- [ ] 业务结构细分到产品
- [ ] 扣非净利润分析（如有投资收益）
- [ ] 三情景估值完整
- [ ] 敏感性分析（可选）
- [ ] 操作建议具体（买入区间/止损位）

### 5.3 格式检查
- [ ] 表格使用Markdown标准格式
- [ ] 产业链图使用ASCII树状图
- [ ] ⭐标注重要性
- [ ] 🟢🟡🔴标注评级/风险

---

## 六、示例报告

详见: 
- `examples/sample_report_multisource.md` - 标准10环节示例
- `examples/report_300666_jf_v5.md` - 江丰电子完整版（含并购分析）

---

*版本: v4.0*  
*更新: 2026-02-27*  
*核心: 10环节流程 + 详细SOP + 并购分析框架*