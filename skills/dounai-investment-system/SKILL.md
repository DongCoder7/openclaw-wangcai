---
name: dounai-investment-system
description: |
  豆奶投资策略系统 - 主控Skill
  
  系统核心功能：
  1. 🔍 产业链分析 - 存储芯片/PCB/半导体深度分析 + Exa全网新闻
  2. 📊 美股报告 - 隔夜美股市场总结 + Exa全网新闻
  3. 🌅 A+H开盘 - 开盘前瞻策略 + Exa全网新闻
  4. 📈 实时行情 - A股/港股/美股实时价格
  5. 📚 知识星球 - 调研纪要获取
  6. 🎯 投资组合 - 建仓建议/持仓诊断
  7. 📰 新闻搜索 - Agent Reach + Exa MCP全网语义搜索（高优先级）
  
  触发方式：
  - "分析存储芯片" → 产业链+知识星球+实时行情
  - "美股报告" → 隔夜美股分析
  - "开盘前瞻" → A+H开盘策略
  - "查002371价格" → 实时行情
  - "知识星球存储" → 调研信息
  
  自动任务：
  - 08:30 美股报告
  - 09:15 A+H开盘
  - 每2小时 知识星球
---

# 豆奶投资策略系统

## 快速入口

### 方式1: 自然语言调用 (推荐)

| 用户需求 | 系统响应 |
|:---------|:---------|
| "分析存储芯片产业链" | 自动调用产业链分析 + 知识星球 + 实时行情 |
| "生成美股报告" | 自动获取美股行情并生成报告 |
| "A+H开盘前瞻" | 自动生成开盘策略 |
| "查北方华创价格" | 返回实时行情 + 建仓建议 |
| "知识星球PCB" | 获取PCB相关调研纪要 |

### 方式2: 函数调用

```python
from skills.dounai_investment_system import DounaiSystem

system = DounaiSystem()

# 产业链分析
result = system.analyze_industry("存储芯片")

# 美股报告
report = system.generate_us_report()

# 实时行情
quotes = system.get_quotes(["002371.SZ", "688012.SH"])
```

---

## 功能模块

### 1️⃣ 产业链深度分析

**调用**: `analyze_industry(industry_name)`

**输入**: 行业名称 (存储芯片/PCB/半导体/新能源)

**输出**:
- 知识星球最新调研信息
- 产业链上下游分析
- 核心标的数据
- 实时行情 + v26因子
- 投资组合建议

**示例**:
```python
result = system.analyze_industry("存储芯片")

print(result['summary'])
# 输出: 
# 长鑫2300亿投资，设备占比65%
# 推荐标的: 北方华创(18%)、拓荆科技(12%)...
```

---

### 2️⃣ 美股市场报告

**调用**: `generate_us_report()`

**自动执行**: 每日08:30

**输出**:
- 道指/纳指/标普表现
- 科技股涨跌
- 中概股表现
- 对A股策略启示

---

### 3️⃣ A+H开盘前瞻

**调用**: `generate_ah_preopen()`

**自动执行**: 每日09:15

**输出**:
- 美股回顾
- A股板块分析
- 港股板块分析
- 开盘策略建议

---

### 4️⃣ 实时行情查询

**调用**: `get_quotes(symbols)`

**支持市场**:
- A股: 002371.SZ, 688012.SH
- 港股: 00700.HK, 09988.HK
- 美股: AAPL.US, NVDA.US

**输出**:
- 最新价格
- 涨跌幅
- 成交量/成交额
- 建仓建议

---

### 5️⃣ 知识星球获取

**调用**: `search_zsxq(keyword)`

**功能**:
- 按关键词搜索调研纪要
- 获取最新文章
- 行业信息聚合

**触发时机**:
- 每次行业/个股分析时自动调用
- 定时任务每2小时自动获取
- 手动搜索按需触发

---

### ⚠️ 重要：财务数据完整性要求

**每次个股分析必须包含以下财务数据**（已自动集成）：

| 数据类型 | 内容 | 来源 | 必须项 |
|:---------|:-----|:-----|:------:|
| **年度业绩** | 最近2年营收/净利润对比 | Tushare | ✅ |
| **年度同比** | YoY增长率 | 计算 | ✅ |
| **季度环比** | 最近4个季度环比变化 | 计算 | ✅ |
| **季度同比** | 最近4个季度同比变化 | 计算 | ✅ |
| **盈利能力** | ROE/毛利率/净利率趋势 | Tushare | ✅ |
| **财务风险** | 负债率/流动性 | Tushare | ✅ |

**禁止事项**:
- ❌ 不得省略同比环比分析
- ❌ 不得使用"待补充"代替实际数据
- ❌ 不得遗漏最近季度数据

**数据验证**：
- 自动从Tushare Pro获取最新财报
- 自动计算同比环比
- 自动生成趋势评价（🟢/🟡/🔴）

---

### 6️⃣ 投资组合管理

**调用**: `analyze_portfolio(stocks)`

**功能**:
- 持仓诊断
- v26因子评分
- 建仓位置建议
- 调仓建议

---

## 自动化配置

### 定时任务 (Crontab)

```bash
# 08:30 美股报告
30 8 * * * cd ~/.openclaw/workspace && python3 -c "from skills.dounai_investment_system import DounaiSystem; DounaiSystem().generate_us_report()"

# 09:15 A+H开盘
15 9 * * * cd ~/.openclaw/workspace && python3 -c "from skills.dounai_investment_system import DounaiSystem; DounaiSystem().generate_ah_preopen()"

# 每2小时 知识星球
0 */2 * * * cd ~/.openclaw/workspace && python3 -c "from skills.dounai_investment_system import DounaiSystem; DounaiSystem().fetch_zsxq()"
```

### Heartbeat集成

在 `HEARTBEAT.md` 中配置自动任务调度。

---

## 数据流

```
用户请求
    ↓
自然语言理解
    ↓
技能路由
    ├─ 产业链分析 → Exa全网搜索(P1) → 知识星球(P2) → 长桥API(P3) + v26因子
    ├─ 个股分析 → Exa全网搜索(P1) → 知识星球(P2) → 长桥API(P3) + 建仓建议
    ├─ 美股报告 → Exa全网搜索(P1) → 新浪财经(P2) → 长桥API(美股)
    ├─ A+H开盘 → Exa全网搜索(P1) → 新浪财经(P2) → 长桥API(A股/港股)
    ├─ 实时行情 → 长桥API
    └─ 知识星球 → zsxq API
    ↓
结果整合
    ↓
输出报告/建议
```

---

## 数据源优先级（个股/行业分析）

| 优先级 | 数据源 | 类型 | 用途 | 触发时机 |
|:------:|--------|------|------|----------|
| **P1** | **Exa全网搜索** | 🔥 AI语义搜索 | 最新新闻/公告/研报 | 每次分析时实时搜索 |
| **P2** | **知识星球** | 📚 调研纪要 | 深度调研/产业链数据 | 每次分析时搜索 |
| **P3** | **长桥API** | 📊 实时行情 | 价格/涨跌幅/成交量 | 每次分析时获取 |
| **P4** | **v26因子** | 📈 量化评分 | 多因子综合评分 | 分析时计算 |
| **P5** | **建仓建议** | 🎯 投资策略 | 仓位/买卖点建议 | 分析后生成 |

### 数据获取流程

**行业分析** (`analyze_industry`):
1. 🔥 **Exa全网搜索** - 搜索行业最新动态、政策变化、突发事件
2. 📚 **知识星球** - 获取调研纪要、产业链数据、专家观点
3. 📊 **长桥API** - 获取相关股票实时行情
4. 🧠 **逻辑分析** - 产业链逻辑分析
5. 🎯 **组合建议** - 生成投资组合建议

**个股分析** (`analyze_stock`):
1. 🔥 **Exa全网搜索** - 搜索个股新闻、公告、研报
2. 📚 **知识星球** - 搜索个股相关调研纪要
3. 📊 **长桥API** - 获取个股实时行情
4. 🎯 **建仓建议** - 根据涨跌幅生成买卖建议

---

## 依赖配置

### 必需
- 长桥API密钥 (`.longbridge.env`)
- 知识星球Token (已配置)
- Exa MCP配置 (`~/.mcporter/mcporter.json`)

### 可选
- Tushare Token (`.tushare.env`)

---

## 示例场景

### 场景1: 存储芯片投资决策

**用户**: "分析存储芯片投资机会"

**系统自动执行**:
1. 🔥 **Exa全网搜索** - 搜索"存储芯片"最新新闻、涨价信息、产能动态
2. 📚 **知识星球** - 搜索"存储芯片"相关调研纪要
3. 📊 **获取存储芯片产业链股票实时行情** - 北方华创、拓荆科技等
4. 📈 **计算v26因子评分**
5. 🎯 **生成投资组合建议**
6. 📋 **输出完整分析报告**

**输出结果**:
```
📊 存储芯片产业链分析报告

【🔥 Exa全网最新动态】
- 存储芯片涨价潮持续，DRAM价格环比上涨15%
- 长鑫存储扩产计划加速，设备招标启动
- 美光科技发布乐观展望，存储周期见底信号明确
...

【📚 知识星球调研纪要】
- 长鑫2300亿投资，设备占比65%
- 国产替代加速，设备商订单饱满
...

【实时行情】
- 北方华创: 496元 (+1.78%)
- 拓荆科技: 360元 (+9.98%) 🔴涨停
...

【推荐组合】
- 北方华创 18%: 订单确定，立即建仓
- 拓荆科技 12%: 等回调5%
...

【预期收益】+16.5%
```

### 场景2: 个股分析

**用户**: "分析北方华创"

**系统自动执行**:
1. 🔥 **Exa全网搜索** - 搜索"北方华创"最新消息、公告、研报
2. 📚 **知识星球** - 搜索"北方华创"相关调研纪要
3. 📊 **获取实时行情** - 当前价格、涨跌幅
4. 🎯 **生成建仓建议** - 根据涨跌幅给出买卖建议

**输出结果**:
```
🔍 北方华创 (002371.SZ) 个股分析报告

【🔥 Exa全网最新动态】
- 北方华创发布业绩预告，Q4订单超预期
- 机构研报：设备龙头地位稳固，维持买入评级
...

【📚 知识星球调研纪要】
- 调研纪要：设备订单饱满，交付周期延长
...

【实时行情】
- 当前价格: 496.00元 (+1.78%)
- 成交量: 12.5亿

【建仓建议】
- 操作建议: 分批建仓 8%
- 理由: 温和上涨，可分批介入
```

### 场景3: 每日开盘准备

**自动执行时间**: 09:15

**系统自动执行**:
1. 📊 获取美股隔夜行情
2. 🌅 获取A+H盘前数据
3. 🔥 **Exa全网搜索** - 盘前最新新闻驱动
4. 📚 **知识星球** - 最新调研纪要
5. 📝 生成开盘策略简报
6. 📤 自动发送报告

---

## 故障处理

### API连接失败
- 自动重试3次
- 失败时返回缓存数据
- 记录错误日志

### 数据缺失
- 使用T-1日数据补充
- 标记数据时效性
- 提示用户注意

---

## 更新日志

| 日期 | 更新内容 |
|:-----|:---------|
| 2026-02-28 | 新增完整财务分析模块（financial_analyzer.py） |
| 2026-02-28 | 修复财务数据缺失同比环比的问题 |
| 2026-02-28 | 自动杜邦分析和风险警示生成 |
| 2026-02-28 | 新增`analyze_stock()`个股分析方法 |
| 2026-02-28 | 更新数据源优先级：Exa搜索 > 知识星球 > 长桥API |
| 2026-02-28 | 集成Agent Reach新闻搜索功能 |
| 2026-02-25 | 集成longport SDK，统一API调用 |
| 2026-02-25 | 添加知识星球自动获取 |
| 2026-02-25 | 完善产业链分析模块 |

---

## 7️⃣ 新闻搜索模块 (Agent Reach)

**调用**: `search_news(keywords, sources=None)`

**功能**:
- 全网新闻检索 (新浪财经/腾讯财经/网易财经)
- 国际新闻获取 (BBC/Reuters等通过Jina Reader)
- YouTube/B站视频内容分析
- RSS订阅源聚合
- 新闻驱动因子识别

**信息源**:
| 来源 | 类型 | 覆盖内容 |
|:-----|:-----|:---------|
| 新浪财经 | 中文财经 | A股/港股/美股/宏观 |
| 腾讯财经 | 中文财经 | 市场动态/行业新闻 |
| 网易财经 | 中文财经 | 美股/国际 |
| Jina Reader | 网页解析 | 任意URL内容 |
| RSS | 订阅源 | 实时推送 |
| YouTube | 视频 | 国际财经频道 |
| B站 | 视频 | 中文财经UP主 |

**示例**:
```python
# 搜索中东局势相关新闻
news = system.search_news("伊朗 以色列 美国 战争", sources=['sina', 'tencent'])

# 输出:
# 📰 中国驻伊朗大使馆郑重提醒
# - 伊朗面临外部安全风险显著上升
# - 提醒在伊中国公民注意安全
```

**集成场景**:
- 产业链分析: 搜索行业最新动态
- 美股报告: 获取隔夜国际新闻
- A+H开盘: 盘前新闻驱动因子
- 投资决策: 突发事件影响评估
