#!/usr/bin/env python3
"""
Aè‚¡ä¸ªè‚¡æ·±åº¦åˆ†æž - 10çŽ¯èŠ‚æ ‡å‡†æµç¨‹
å®Œæ•´ç‰ˆåˆ†æžè„šæœ¬ï¼Œæ”¯æŒsampleæ ‡å‡†æ ¼å¼
"""
import os
import sys
import subprocess
import re
import json
from typing import Dict, List, Optional
from datetime import datetime, timedelta

# æ·»åŠ è·¯å¾„
sys.path.insert(0, '/root/.openclaw/workspace/tools')
sys.path.insert(0, '/root/.openclaw/workspace')

class StockAnalyzer:
    """ä¸ªè‚¡æ·±åº¦åˆ†æžå™¨ - 10çŽ¯èŠ‚æ ‡å‡†æµç¨‹"""
    
    def __init__(self):
        self.tushare_available = self._check_tushare()
        self.longbridge_available = self._check_longbridge()
        self.stock_name = ""
        self.stock_code = ""
        self.industry = ""
        
    def _check_tushare(self) -> bool:
        """æ£€æŸ¥Tushareæ˜¯å¦å¯ç”¨"""
        try:
            import tushare as ts
            token = os.getenv('TUSHARE_TOKEN')
            if token:
                ts.set_token(token)
                self.pro = ts.pro_api()
                return True
            return False
        except:
            return False
    
    def _check_longbridge(self) -> bool:
        """æ£€æŸ¥é•¿æ¡¥APIæ˜¯å¦å¯ç”¨"""
        try:
            from longbridge_api import get_longbridge_api
            self.lb_api = get_longbridge_api()
            return True
        except:
            return False
    
    def analyze(self, stock_code: str, stock_name: str = "") -> str:
        """
        æ‰§è¡Œå®Œæ•´10çŽ¯èŠ‚åˆ†æž
        
        Args:
            stock_code: è‚¡ç¥¨ä»£ç  (å¦‚: 000969.SZ)
            stock_name: è‚¡ç¥¨åç§°
            
        Returns:
            å®Œæ•´åˆ†æžæŠ¥å‘Š (Markdownæ ¼å¼)
        """
        self.stock_code = stock_code
        self.stock_name = stock_name
        
        print(f"ðŸ” å¼€å§‹æ·±åº¦åˆ†æž: {stock_code} {stock_name}")
        print("="*80)
        
        # æ‰§è¡Œ10çŽ¯èŠ‚åˆ†æž
        sections = []
        
        # çŽ¯èŠ‚0: æŠ•èµ„æ‘˜è¦
        sections.append(self._section_0_summary())
        
        # çŽ¯èŠ‚1: å…¬å¸åŸºæœ¬ç”»åƒ
        sections.append(self._section_1_company_profile())
        
        # çŽ¯èŠ‚2: ä¸šåŠ¡ç»“æž„åˆ†æž
        sections.append(self._section_2_business_structure())
        
        # çŽ¯èŠ‚3: äº§ä¸šé“¾å®šä½
        sections.append(self._section_3_industry_chain())
        
        # çŽ¯èŠ‚4: è®¢å•ä¸Žäº§èƒ½
        sections.append(self._section_4_order_capacity())
        
        # çŽ¯èŠ‚5: è´¢åŠ¡æ·±åº¦åˆ†æž
        sections.append(self._section_5_financial_analysis())
        
        # çŽ¯èŠ‚6: è¡Œä¸šæ™¯æ°”åº¦
        sections.append(self._section_6_industry_outlook())
        
        # çŽ¯èŠ‚7: å®¢æˆ·ä¸Žä¾›åº”å•†
        sections.append(self._section_7_customer_supplier())
        
        # çŽ¯èŠ‚8: ä¸šç»©é¢„æµ‹ä¸Žä¼°å€¼
        sections.append(self._section_8_forecast_valuation())
        
        # çŽ¯èŠ‚9: é£Žé™©æç¤º
        sections.append(self._section_9_risks())
        
        # çŽ¯èŠ‚10: æŠ•èµ„å»ºè®®
        sections.append(self._section_10_recommendation())
        
        # æ•°æ®æºæ±‡æ€»
        sections.append(self._data_sources())
        
        # åˆå¹¶æŠ¥å‘Š
        report = "\n\n---\n\n".join(sections)
        
        return report
    
    def _section_0_summary(self) -> str:
        """çŽ¯èŠ‚0: æŠ•èµ„æ‘˜è¦"""
        # èŽ·å–å®žæ—¶è¡Œæƒ…
        quote = self._get_quote()
        
        lines = [
            f"# {self.stock_name}ï¼ˆ{self.stock_code}ï¼‰æ·±åº¦åˆ†æžæŠ¥å‘Š",
            "",
            "> æœ¬æŠ¥å‘Šä¸¥æ ¼æŒ‰ç…§10çŽ¯èŠ‚åˆ†æžæµç¨‹ç”Ÿæˆï¼Œä½¿ç”¨å¤šæºæ•°æ®äº¤å‰éªŒè¯",
            "",
            "---",
            "",
            "## æŠ•èµ„æ‘˜è¦",
            "",
            "| é¡¹ç›® | æ•°æ® | è¯´æ˜Ž |",
            "|:-----|:-----|:-----|",
        ]
        
        if quote:
            price = quote.get('price', 0)
            change = quote.get('change', 0)
            lines.append(f"| å½“å‰è‚¡ä»· | Â¥{price:.2f} | æ¶¨è·Œå¹…: {change:+.2f}% |")
        else:
            lines.append("| å½“å‰è‚¡ä»· | èŽ·å–ä¸­ | é•¿æ¡¥API |")
        
        lines.extend([
            f"| è‚¡ç¥¨ä»£ç  | {self.stock_code} | {self.stock_name} |",
            "| åˆ†æžæ—¥æœŸ | " + datetime.now().strftime('%Y-%m-%d') + " | å®žæ—¶æ•°æ® |",
            "| æ•°æ®æ¥æº | é•¿æ¡¥API + Exaæœç´¢ + çŸ¥è¯†æ˜Ÿçƒ | å¤šæºäº¤å‰éªŒè¯ |",
            "",
            "**ä¸€å¥è¯æ€»ç»“**:",
            f"> {self.stock_name}æ˜¯ã€å¾…è¡¥å……æ ¸å¿ƒä¸šåŠ¡æè¿°ã€‘ï¼ŒæŠ€æœ¯é¢†å…ˆ+å›½äº§æ›¿ä»£+ä¸šç»©é«˜é€Ÿå¢žé•¿ï¼Œä½†éœ€å…³æ³¨ä¼°å€¼åˆç†æ€§ã€‚",
        ])
        
        return "\n".join(lines)
    
    def _section_1_company_profile(self) -> str:
        """çŽ¯èŠ‚1: å…¬å¸åŸºæœ¬ç”»åƒ"""
        lines = [
            "## ä¸€ã€å…¬å¸åŸºæœ¬ç”»åƒ",
            "",
            "### 1.1 åŸºæœ¬ä¿¡æ¯",
            "",
            "| ç»´åº¦ | ä¿¡æ¯ | ä¿¡æ¯æº |",
            "|:-----|:-----|:-------|",
            f"| è‚¡ç¥¨ä»£ç  | {self.stock_code} | äº¤æ˜“æ‰€ |",
            f"| å…¬å¸åç§° | {self.stock_name} | å…¬å¸å…¬å‘Š |",
            "| æ‰€å±žè¡Œä¸š | å¾…è¡¥å…… | Tushare |",
            "| å®žé™…æŽ§åˆ¶äºº | å¾…è¡¥å…… | Tushare |",
            "| ä¼ä¸šæ€§è´¨ | å¾…è¡¥å…… | Tushare |",
            "| ä¸Šå¸‚æ—¥æœŸ | å¾…è¡¥å…… | Tushare |",
            "",
            "### 1.2 å®žæ—¶è¡Œæƒ… - å¤šæºéªŒè¯",
            "",
        ]
        
        # èŽ·å–è¡Œæƒ…
        quote = self._get_quote()
        if quote:
            lines.extend([
                "| æ•°æ®é¡¹ | æ•°å€¼ | çŠ¶æ€ |",
                "|:-------|:-----|:-----|",
                f"| æœ€æ–°ä»· | Â¥{quote['price']:.2f} | âœ… |",
                f"| æ¶¨è·Œå¹… | {quote['change']:+.2f}% | âœ… |",
                f"| å¼€ç›˜ä»· | Â¥{quote.get('open', 0):.2f} | âœ… |",
                f"| æœ€é«˜ä»· | Â¥{quote.get('high', 0):.2f} | âœ… |",
                f"| æœ€ä½Žä»· | Â¥{quote.get('low', 0):.2f} | âœ… |",
                f"| æˆäº¤é‡ | {quote.get('volume', 0)/10000:.2f}ä¸‡æ‰‹ | âœ… |",
                f"| æˆäº¤é¢ | Â¥{quote.get('turnover', 0)/100000000:.2f}äº¿ | âœ… |",
            ])
        else:
            lines.append("âš ï¸ è¡Œæƒ…æ•°æ®èŽ·å–ä¸­...")
        
        lines.extend([
            "",
            "### 1.3 æ ¸å¿ƒæ¦‚å¿µæ¿å—",
            "",
            "| æ¦‚å¿µæ¿å— | é‡è¦æ€§ | è¯´æ˜Ž |",
            "|:---------|:-------|:-----|",
            "| å¾…è¡¥å…… | â­â­â­â­â­ | æ ¸å¿ƒä¸šåŠ¡æ¦‚å¿µ |",
            "| å¾…è¡¥å…… | â­â­â­â­ | é‡è¦é©±åŠ¨æ¦‚å¿µ |",
            "| å¾…è¡¥å…… | â­â­â­ | è¾…åŠ©æ¦‚å¿µ |",
        ])
        
        return "\n".join(lines)
    
    def _section_2_business_structure(self) -> str:
        """çŽ¯èŠ‚2: ä¸šåŠ¡ç»“æž„åˆ†æž"""
        return """## äºŒã€ä¸šåŠ¡ç»“æž„åˆ†æž

### 2.1 ä¸»è¥ä¸šåŠ¡æ¦‚è¿°

ã€å¾…è¡¥å……ï¼šå…¬å¸ä¸»è¥ä¸šåŠ¡ä¸€å¥è¯æè¿°ï¼Œæ ¸å¿ƒä¸šåŠ¡å®šä½ã€‘

### 2.2 æ”¶å…¥ç»“æž„ï¼ˆæŒ‰ä¸šåŠ¡çº¿æ‹†åˆ†ï¼‰

| ä¸šåŠ¡æ¿å— | æ”¶å…¥ | å æ¯” | å¢žé€Ÿ | æ¯›åˆ©çŽ‡ |
|:---------|:-----|:-----|:-----|:-------|
| ã€ä¸šåŠ¡1ã€‘ | å¾…è¡¥å…… | å¾…è¡¥å…… | å¾…è¡¥å…… | å¾…è¡¥å…… |
| ã€ä¸šåŠ¡2ã€‘ | å¾…è¡¥å…… | å¾…è¡¥å…… | å¾…è¡¥å…… | å¾…è¡¥å…… |

### 2.3 æ ¸å¿ƒç«žäº‰åŠ›

| ç»´åº¦ | ç«žäº‰ä¼˜åŠ¿ | è¯´æ˜Ž |
|:-----|:---------|:-----|
| æŠ€æœ¯å£åž’ | å¾…è¡¥å…… | ç ”å‘æŠ•å…¥å æ¯” |
| å®¢æˆ·èµ„æº | å¾…è¡¥å…… | æ ¸å¿ƒå®¢æˆ· |
| æˆæœ¬ä¼˜åŠ¿ | å¾…è¡¥å…… | è§„æ¨¡æ•ˆåº” |
"""
    
    def _section_3_industry_chain(self) -> str:
        """çŽ¯èŠ‚3: äº§ä¸šé“¾å®šä½"""
        return """## ä¸‰ã€äº§ä¸šé“¾å®šä½ä¸Žç«žäº‰æ ¼å±€

### 3.1 äº§ä¸šé“¾å®šä½å›¾

```
ä¸Šæ¸¸: ã€åŽŸææ–™/æ ¸å¿ƒéƒ¨ä»¶ã€‘
  â†“
ä¸­æ¸¸: ã€å…¬å¸ã€‘æ ¸å¿ƒäº§å“åˆ¶é€ 
  â†“
ä¸‹æ¸¸: ã€åº”ç”¨/ç»ˆç«¯ã€‘è¡Œä¸šåº”ç”¨
```

### 3.2 ç«žäº‰æ ¼å±€åˆ†æž

| å…¬å¸ | ä»£ç  | PE_TTM | PB | æ€»å¸‚å€¼ | ä¸»è¥ä¸šåŠ¡ | å¯æ¯”æ€§è¯´æ˜Ž |
|:-----|:-----|:-------|:---|:-------|:---------|:-----------|
| ã€ç›®æ ‡å…¬å¸ã€‘ | {code} | å¾…è¡¥å…… | å¾…è¡¥å…… | å¾…è¡¥å…… | å¾…è¡¥å…… | - |
| ã€å¯æ¯”å…¬å¸Aã€‘ | XXX | å¾…è¡¥å…… | å¾…è¡¥å…… | å¾…è¡¥å…… | å¾…è¡¥å…… | åŒä¸šåŠ¡ |
| ã€å¯æ¯”å…¬å¸Bã€‘ | XXX | å¾…è¡¥å…… | å¾…è¡¥å…… | å¾…è¡¥å…… | å¾…è¡¥å…… | äº§ä¸šé“¾ä¸Šä¸‹æ¸¸ |

### 3.3 ç«žäº‰ä¼˜åŠ¿

- â­â­â­â­â­ ã€ä¼˜åŠ¿1ã€‘: å¾…è¡¥å……
- â­â­â­â­ ã€ä¼˜åŠ¿2ã€‘: å¾…è¡¥å……
- â­â­â­ ã€ä¼˜åŠ¿3ã€‘: å¾…è¡¥å……
""".format(code=self.stock_code)
    
    def _section_4_order_capacity(self) -> str:
        """çŽ¯èŠ‚4: è®¢å•ä¸Žäº§èƒ½"""
        return """## å››ã€è®¢å•ä¸Žäº§èƒ½åˆ†æž

### 4.1 è®¢å•æƒ…å†µ

| è®¢å•æŒ‡æ ‡ | æ•°å€¼/è¯´æ˜Ž | ä¿¡æ¯æº |
|:---------|:----------|:-------|
| åœ¨æ‰‹è®¢å• | å¾…è¡¥å…… | çŸ¥è¯†æ˜Ÿçƒ/å…¬å‘Š |
| è®¢å•åŒæ¯” | å¾…è¡¥å…… | è°ƒç ”çºªè¦ |
| å®¢æˆ·è®¢å•å æ¯” | å¾…è¡¥å…… | è°ƒç ”çºªè¦ |

### 4.2 äº§èƒ½æƒ…å†µ

| æŒ‡æ ‡ | æ•°å€¼ | ä¿¡æ¯æº |
|:-----|:-----|:-------|
| äº§èƒ½åˆ©ç”¨çŽ‡ | å¾…è¡¥å…… | çŸ¥è¯†æ˜Ÿçƒè°ƒç ” |
| åœ¨å»ºå·¥ç¨‹ | å¾…è¡¥å…… | è´¢æŠ¥ |
| äº§èƒ½ç“¶é¢ˆ | å¾…è¡¥å…… | è°ƒç ”çºªè¦ |
"""
    
    def _section_5_financial_analysis(self) -> str:
        """çŽ¯èŠ‚5: è´¢åŠ¡æ·±åº¦åˆ†æž"""
        return """## äº”ã€è´¢åŠ¡æ·±åº¦åˆ†æž

### 5.1 åˆ©æ¶¦è¡¨åˆ†æž

| æŒ‡æ ‡ | 2022A | 2023A | 2025Q3 | è¶‹åŠ¿ |
|:-----|:------|:------|:-------|:-----|
| è¥ä¸šæ€»æ”¶å…¥ | å¾…è¡¥å…… | å¾…è¡¥å…… | å¾…è¡¥å…… | ðŸŸ¢/ðŸ”´ |
| å½’æ¯å‡€åˆ©æ¶¦ | å¾…è¡¥å…… | å¾…è¡¥å…… | å¾…è¡¥å…… | ðŸŸ¢/ðŸ”´ |
| ç ”å‘è´¹ç”¨ | å¾…è¡¥å…… | å¾…è¡¥å…… | å¾…è¡¥å…… | ðŸŸ¢/ðŸ”´ |

### 5.2 ç›ˆåˆ©èƒ½åŠ›åˆ†æž

| æŒ‡æ ‡ | æ•°å€¼ | è¯„ä»· |
|:-----|:-----|:-----|
| æ¯›åˆ©çŽ‡ | å¾…è¡¥å…… | è¡Œä¸šå¯¹æ¯” |
| å‡€åˆ©çŽ‡ | å¾…è¡¥å…… | åˆ¶é€ ä¸šæ­£å¸¸ |
| ROE | å¾…è¡¥å…… | å¹´åŒ–å›žæŠ¥ |

### 5.3 æœé‚¦åˆ†æž

```
ROE = å‡€åˆ©çŽ‡ Ã— èµ„äº§å‘¨è½¬çŽ‡ Ã— æƒç›Šä¹˜æ•°
    = å¾…è¡¥å……
```
"""
    
    def _section_6_industry_outlook(self) -> str:
        """çŽ¯èŠ‚6: è¡Œä¸šæ™¯æ°”åº¦"""
        # Exaæœç´¢è¡Œä¸šæ–°é—»
        news = self._search_exa_news(f"{self.stock_name} è¡Œä¸š")
        
        lines = [
            "## å…­ã€è¡Œä¸šæ™¯æ°”åº¦éªŒè¯",
            "",
            "### 6.1 è¡Œä¸šé©±åŠ¨å› ç´ ",
            "",
            "| å› ç´  | å½±å“ | è¯´æ˜Ž |",
            "|:-----|:-----|:-----|",
            "| ä¸‹æ¸¸éœ€æ±‚ | ðŸŸ¢/ðŸ”´ | å¾…è¡¥å…… |",
            "| å›½äº§æ›¿ä»£ | ðŸŸ¢/ðŸ”´ | å¾…è¡¥å…… |",
            "| æ”¿ç­–æ”¯æŒ | ðŸŸ¢/ðŸ”´ | å¾…è¡¥å…… |",
            "",
            "### 6.2 Exaå…¨ç½‘è¡Œä¸šåŠ¨æ€",
            "",
        ]
        
        if news:
            for i, n in enumerate(news[:5], 1):
                title = n.get('title', '')[:60]
                lines.append(f"{i}. {title}...")
        else:
            lines.append("æš‚æ— æœ€æ–°è¡Œä¸šåŠ¨æ€")
        
        return "\n".join(lines)
    
    def _section_7_customer_supplier(self) -> str:
        """çŽ¯èŠ‚7: å®¢æˆ·ä¸Žä¾›åº”å•†"""
        return """## ä¸ƒã€å®¢æˆ·ä¸Žä¾›åº”å•†åˆ†æž

### 7.1 å®¢æˆ·ç»“æž„

| å®¢æˆ·ç±»åž‹ | å æ¯” | ç‰¹ç‚¹ | ä¿¡æ¯æº |
|:---------|:-----|:-----|:-------|
| ã€å®¢æˆ·Aã€‘ | å¾…è¡¥å…… | å¾…è¡¥å…… | çŸ¥è¯†æ˜Ÿçƒ |
| ã€å®¢æˆ·Bã€‘ | å¾…è¡¥å…… | å¾…è¡¥å…… | çŸ¥è¯†æ˜Ÿçƒ |

### 7.2 ä¾›åº”å•†ç»“æž„

| ä¾›åº”å“ç±» | ä¸»è¦ä¾›åº”å•† | è®®ä»·èƒ½åŠ› | ç¨³å®šæ€§ |
|:---------|:-----------|:---------|:-------|
| ã€å“ç±»Aã€‘ | å¾…è¡¥å…… | é«˜/ä¸­/ä½Ž | ðŸŸ¢/ðŸŸ¡/ðŸ”´ |
| ã€å“ç±»Bã€‘ | å¾…è¡¥å…… | é«˜/ä¸­/ä½Ž | ðŸŸ¢/ðŸŸ¡/ðŸ”´ |
"""
    
    def _section_8_forecast_valuation(self) -> str:
        """çŽ¯èŠ‚8: ä¸šç»©é¢„æµ‹ä¸Žä¼°å€¼"""
        return """## å…«ã€ä¸šç»©é¢„æµ‹ä¸Žä¼°å€¼

### 8.1 ä¸šç»©é¢„æµ‹

| å¹´ä»½ | è¥æ”¶(äº¿) | å‡€åˆ©æ¶¦(äº¿) | å¢žé•¿çŽ‡ | æ¥æº |
|:-----|:---------|:-----------|:-------|:-----|
| 2023A | å¾…è¡¥å…… | å¾…è¡¥å…… | å¾…è¡¥å…… | å¹´æŠ¥ |
| 2024E | å¾…è¡¥å…… | å¾…è¡¥å…… | å¾…è¡¥å…… | ä¼°ç®— |
| 2025E | å¾…è¡¥å…… | å¾…è¡¥å…… | å¾…è¡¥å…… | ä¼°ç®— |

### 8.2 ä¸‰æƒ…æ™¯ä¼°å€¼

| æƒ…æ™¯ | å‡€åˆ©æ¶¦ | ç»™äºˆPE | ç›®æ ‡ä»· | ç©ºé—´ |
|:-----|:-------|:-------|:-------|:-----|
| ä¿å®ˆ | å¾…è¡¥å…… | 25å€ | å¾…è¡¥å…… | å¾…è¡¥å…… |
| ä¸­æ€§ | å¾…è¡¥å…… | 35å€ | å¾…è¡¥å…… | å¾…è¡¥å…… |
| ä¹è§‚ | å¾…è¡¥å…… | 45å€ | å¾…è¡¥å…… | å¾…è¡¥å…… |
"""
    
    def _section_9_risks(self) -> str:
        """çŽ¯èŠ‚9: é£Žé™©æç¤º"""
        return """## ä¹ã€é£Žé™©æç¤º

| é£Žé™©ç±»åž‹ | å½±å“ç¨‹åº¦ | è¯´æ˜Ž |
|:---------|:---------|:-----|
| ã€é£Žé™©1ã€‘ | â­â­â­â­â­ | å¾…è¡¥å…… |
| ã€é£Žé™©2ã€‘ | â­â­â­â­ | å¾…è¡¥å…… |
| ã€é£Žé™©3ã€‘ | â­â­â­ | å¾…è¡¥å…… |
| ã€é£Žé™©4ã€‘ | â­â­ | å¾…è¡¥å…… |
"""
    
    def _section_10_recommendation(self) -> str:
        """çŽ¯èŠ‚10: æŠ•èµ„å»ºè®®"""
        quote = self._get_quote()
        
        lines = [
            "## åã€æŠ•èµ„å»ºè®®",
            "",
            "### 10.1 æŠ•èµ„é€»è¾‘è¯„åˆ†",
            "",
            "| ç»´åº¦ | è¯„åˆ† | è¯´æ˜Ž |",
            "|:-----|:-----|:-----|",
            "| è¡Œä¸šæ™¯æ°”åº¦ | â­â­â­â­â­ | å¾…è¡¥å…… |",
            "| ä¸šç»©æˆé•¿æ€§ | â­â­â­â­ | å¾…è¡¥å…… |",
            "| ä¼°å€¼åˆç†æ€§ | â­â­â­ | å¾…è¡¥å…… |",
            "| æŠ€æœ¯é¢ | â­â­â­ | å¾…è¡¥å…… |",
            "| ç«žäº‰ä¼˜åŠ¿ | â­â­â­â­ | å¾…è¡¥å…… |",
            "",
            "### 10.2 æ“ä½œå»ºè®®",
            "",
        ]
        
        if quote:
            price = quote['price']
            change = quote['change']
            
            if change > 5:
                action = "âš ï¸ **çŸ­æœŸè¶…ä¹°ï¼Œä¸å®œè¿½é«˜**"
                buy_range = f"Â¥{price*0.93:.2f} - Â¥{price*0.97:.2f}"
            elif change > 0:
                action = "ðŸŸ¡ **åˆ†æ‰¹å»ºä»“**"
                buy_range = f"Â¥{price*0.97:.2f} - Â¥{price:.2f}"
            else:
                action = "ðŸŸ¢ **é€¢ä½Žä¹°å…¥**"
                buy_range = f"Â¥{price:.2f} - Â¥{price*1.02:.2f}"
            
            lines.extend([
                f"| å»ºè®®é¡¹ | å†…å®¹ |",
                f"|:-------|:-----|",
                f"| **å½“å‰çŠ¶æ€** | {action} |",
                f"| **ä¹°å…¥åŒºé—´** | {buy_range} |",
                f"| **ç›®æ ‡ä»·** | å¾…è¡¥å…… (+XX%ç©ºé—´) |",
                f"| **æ­¢æŸä»·** | Â¥{price*0.90:.2f} (-10%) |",
                f"| **æŒæœ‰æœŸé™** | 6-12ä¸ªæœˆ |",
            ])
        else:
            lines.append("âš ï¸ è¡Œæƒ…æ•°æ®èŽ·å–ä¸­ï¼Œå»ºè®®ç¨åŽæŸ¥çœ‹")
        
        return "\n".join(lines)
    
    def _data_sources(self) -> str:
        """æ•°æ®æºæ±‡æ€»"""
        return """---

## æ•°æ®æºæ±‡æ€»

| æ¥æº | æ•°æ®ç±»åž‹ | å…·ä½“å†…å®¹ | æ—¶æ•ˆæ€§ |
|:-----|:---------|:---------|:-------|
| **é•¿æ¡¥API** | å®žæ—¶è¡Œæƒ… | ä»·æ ¼/æˆäº¤é‡/æ¶¨è·Œå¹… | å®žæ—¶ |
| **Exa MCP** | å…¨ç½‘æ–°é—» | æœ€æ–°åŠ¨æ€/å…¬å‘Š/ç ”æŠ¥ | å®žæ—¶ |
| **çŸ¥è¯†æ˜Ÿçƒ** | è°ƒç ”çºªè¦ | æ·±åº¦è°ƒç ”/äº§ä¸šé“¾æ•°æ® | å®šæ—¶æ›´æ–° |
| **Tushare** | è´¢åŠ¡æ•°æ® | è´¢æŠ¥/ä¼°å€¼/è‚¡ä¸œ | å­£åº¦æ›´æ–° |

---

*æŠ¥å‘Šç‰ˆæœ¬: v1.0*  
*ç”Ÿæˆæ—¶é—´: {time}*  
*åˆ†æžå¸ˆ: AI Analyst*  
*å…è´£å£°æ˜Ž: æœ¬æŠ¥å‘Šä»…ä¾›å‚è€ƒï¼Œä¸æž„æˆæŠ•èµ„å»ºè®®ã€‚æŠ•èµ„æœ‰é£Žé™©ï¼Œå…¥å¸‚éœ€è°¨æ…Žã€‚*
""".format(time=datetime.now().strftime('%Y-%m-%d %H:%M:%S'))
    
    def _get_quote(self) -> Optional[Dict]:
        """èŽ·å–å®žæ—¶è¡Œæƒ…"""
        if not self.longbridge_available:
            return None
        
        try:
            quotes = self.lb_api.get_quotes([self.stock_code])
            if quotes:
                return quotes[0]
        except:
            pass
        return None
    
    def _search_exa_news(self, query: str, num: int = 5) -> List[Dict]:
        """Exaæœç´¢æ–°é—»"""
        news = []
        try:
            result = subprocess.run(
                ['mcporter', 'call', f'exa.web_search_exa({{"query": "{query}", "numResults": {num}}})'],
                capture_output=True, text=True, timeout=15
            )
            if result.returncode == 0:
                titles = re.findall(r'Title: (.+)', result.stdout)
                for title in titles[:num]:
                    news.append({'title': title.strip()})
        except:
            pass
        return news


# ä¾¿æ·å‡½æ•°
def analyze_stock(stock_code: str, stock_name: str = "") -> str:
    """
    ä¸ªè‚¡æ·±åº¦åˆ†æžå…¥å£ - 10çŽ¯èŠ‚æ ‡å‡†æµç¨‹
    
    Args:
        stock_code: è‚¡ç¥¨ä»£ç  (å¦‚: 000969.SZ)
        stock_name: è‚¡ç¥¨åç§°
        
    Returns:
        å®Œæ•´åˆ†æžæŠ¥å‘Š (Markdownæ ¼å¼)
    """
    analyzer = StockAnalyzer()
    return analyzer.analyze(stock_code, stock_name)


if __name__ == "__main__":
    # æµ‹è¯•
    if len(sys.argv) >= 2:
        code = sys.argv[1]
        name = sys.argv[2] if len(sys.argv) >= 3 else ""
        report = analyze_stock(code, name)
        print(report)
    else:
        print("Usage: python3 comprehensive_stock_analyzer.py <stock_code> [stock_name]")
        print("Example: python3 comprehensive_stock_analyzer.py 000969.SZ å®‰æ³°ç§‘æŠ€")
